<div
    class="custom-table-header d-flex justify-content-between align-items-center mb-0 p-2 rounded-top bg-light fw-bold mt-5">
    <div class="me-3 text-center min-width-8 mycolour">
        Sub Tasks
    </div>
    <div class="d-flex align-items-center gap-5">

        <div class="d-flex align-items-center gap-2">
            <div class="text-nowrap">From Date:</div>
            <input class="custom-input" type="date" [(ngModel)]="fromDateSubTask" />
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="text-nowrap m">To Date:</div>

            <input class="custom-input" type="date" [(ngModel)]="toDateSubTask" />
        </div>

        @if(isFilteredSubTask){
        <button class="custom-btn min-width-6" (click)="isFilteredSubTask = false">
            Clear Filter
        </button>

        }
        @else {
        <button class="custom-btn min-width-6" (click)="isFilteredSubTask = true">
            Apply Filter
        </button>
        }
    </div>

    <i class="bi mycolour" [ngClass]="isOpenSelfSubTasks ? 'bi-chevron-up' : 'bi-chevron-down'"
        (click)="isOpenSelfSubTasks = !isOpenSelfSubTasks" style="cursor: pointer; font-size: 1.6rem; min-width: 3vw;">
    </i>
</div>

@if(isOpenSelfSubTasks) {
<div class="container-fluid m-0 p-0 small">
    <div class="">
        <table class="table table-bordered-my table-hover table-striped">
            <thead class="sticky-top">
                <tr class="text-nowrap text-center align-middle custom-table-header-clr">
                    <th></th>
                    <th>S.No.</th>
                    <th class="sticky-sub-task-name">SubTask Name</th>
                    <th>Remark</th>
                    <th>ETA</th>
                    <th>Status</th>
                    <th><span>ETA</span><br><span>Approval</span></th>
                    <th></th>

                </tr>
            </thead>
            <tbody class="text-wrap">

                @for (subTask of filteredSubTasks; track $index) {
                <tr class="align-middle text-center">

                    @if(!subTask.isEditing){

                    <td>
                        <div class="d-flex gap-1 align-items-center justify-content-center">
                            <button class="custom-btn" (click)="subTask.isEditing = true">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="custom-btn">
                                <!-- (click)="addWorkHrs(subTask)" -->
                                <i class="bi bi-stopwatch"></i>
                            </button>
                        </div>
                    </td>
                    <td>{{ subTask.subTaskSeq }}</td>
                    <td class="display-text-area-data sticky-sub-task-name">{{ subTask.subTaskName }}</td>
                    <td class="display-text-area-data min-width-8 max-width-12">{{ subTask.remark }}</td>
                    <td>{{ subTask.subTaskETA | displayHrs }}</td>
                    <td class="text-nowrap">
                        <span class="badge fs-7"
                            [ngStyle]="{'background-color': colorMap[subTask.status.charAt(0)] || '#4CAF50'}">{{
                            subTask.status }}</span>

                    </td>

                    }
                    @else {

                    <td>
                        <button class="custom-btn" (click)="subTask.isEditing = false; updateSelfSubTask(subTask)">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </td>
                    <td>
                        <input class="custom-input min-max-width-4" type="number" step="1" min="0" inputmode="numeric"
                            [(ngModel)]="subTask.subTaskSeq"
                            (input)="subTask.subTaskSeq = Math.floor(subTask.subTaskSeq || 0)" />
                    </td>
                    <td class="sticky-sub-task-name">
                        <textarea class="custom-input-textarea" [(ngModel)]="subTask.subTaskName" rows="2"></textarea>
                    </td>
                    <td>
                        <textarea class="custom-input-textarea" [(ngModel)]="subTask.remark" rows="2"></textarea>
                    </td>
                    <td>
                        @if(!subTask.isApprove){
                        <input class="custom-input min-max-width-4" type="number" step="0.5" min="0" inputmode="decimal"
                            [(ngModel)]="subTask.subTaskETA" />

                        }
                        @else {
                        {{ subTask.subTaskETA | displayHrs }}
                        }
                    </td>
                    <td>
                        <select class="form-select form-select-sm custom-input-colour w-auto"
                            [(ngModel)]="subTask.status">
                            @for (status of subTaskStatusList; track $index) {
                            <option [ngValue]="status">{{ status }}</option>
                            }
                        </select>
                    </td>

                    }
                    <td>
                        <span class="badge fs-7" [ngClass]="subTask.isApprove ? 'bg-success' : 'bg-danger'">{{
                            subTask.isApprove ? 'Approved' : 'Pending' }}</span>
                    </td>
                    <td>
                        <!-- @if(!subTask.isOpen){
                        <button class="custom-btn" (click)="subTask.isOpen = true">
                            View Time
                        </button>
                        }

                        @else {
                        <button class="custom-btn pt-1" (click)="subTask.isOpen = false">
                            Hide Time
                        </button> -->

                        <!-- 
                        
                        This Roshan
                        
                        <div class="align-items-center flex-wrap justify-content-center mt-2 ">

                            @for (workEntry of subTask.workEntrys; track $index) {

                            <div class="work-entry-edit-td">
                                <span class="">{{workEntry.entryDate| julianToDate}}</span> — <strong>

                                    @if(!workEntry.isEditing){
                                    <span class="badge "
                                        style="color: black; background-color: azure; font-size: 0.9rem">{{workEntry.entryHrs
                                        | displayHrs}}</span>
                                    <button class="work-entry-edit-btn" (click)="workEntry.isEditing = true">
                                        <i class="bi bi-pencil-square small-icon mycolour"></i>
                                    </button>
                                    }
                                    @else {
                                    <input class="custom-input min-max-width-4" type="number" step="0.5" min="0"
                                        inputmode="decimal" [(ngModel)]="workEntry.entryHrs"
                                        (blur)="workEntry.isEditing = false;updateWorkHrs(workEntry)" />
                                    }

                                </strong>
                            </div>
                            }
                        </div> -->


                        <!-- } -->



                        <!-- <details class="">
                           

                            <summary>View Time</summary>
                            <div class="align-items-center flex-wrap justify-content-center mt-2 ">

                                @for (workEntry of subTask.workEntrys; track $index) {

                                <div>
                                    <span class="">{{workEntry.entryDate| julianToDate}}</span> — <strong>

                                        @if(!workEntry.isEditing){
                                        <span class="badge "
                                            style="color: black; background-color: azure; font-size: 0.9rem">{{workEntry.entryHrs
                                            |
                                            displayHrs}}</span>
                                        <button class="work-entry-edit-btn" (click)="workEntry.isEditing = true">
                                            <i class="bi bi-pencil-square small-icon mycolour"></i>
                                        </button>
                                        }
                                        @else {
                                        <input class="custom-input min-max-width-4" type="number" step="0.5" min="0"
                                            inputmode="decimal" [(ngModel)]="workEntry.entryHrs"
                                            (blur)="workEntry.isEditing = false;updateWorkHrs(workEntry)" />
                                        }

                                    </strong>
                                </div>
                                }
                            </div>
                        </details> -->

                    </td>

                </tr>
                }
            </tbody>
        </table>

    </div>



    <div class="custom-table-footer d-flex justify-content-between align-items-center p-2 rounded-bottom">
        <div>Showing {{ subTasks.length }} SubTasks</div>
        <div class="flex-grow-1 d-flex justify-content-center">
            <button class="custom-btn" (click)="addSelfSubTask()">Add New Sub Task</button>
        </div>
    </div>
</div>

}


<!-- ================================================================================ -->

<div
    class="custom-table-header d-flex justify-content-between align-items-center mb-0 p-2 rounded-top bg-light fw-bold mt-2">
    <div class="px-5 text-center mycolour">
        Other Resource Sub Tasks (Contribution of other resources)
    </div>

    <i class="bi mycolour" [ngClass]="isOpenOtherSubTasks ? 'bi-chevron-up' : 'bi-chevron-down'"
        (click)="isOpenOtherSubTasks = !isOpenOtherSubTasks"
        style="cursor: pointer; font-size: 1.6rem; min-width: 3vw;">
    </i>
</div>

@if(isOpenOtherSubTasks) {
<div class="container-fluid m-0 p-0 small">
    <div class="">
        <table class="table table-bordered-my table-hover table-striped">
            <thead class="sticky-top">
                <tr class="text-nowrap text-center align-middle custom-table-header-clr">
                    <th></th>
                    <th>S.No.</th>
                    <th class="sticky-sub-task-name">SubTask Name</th>
                    <th>Remark</th>
                    <th>Status</th>
                    <th></th>

                </tr>
            </thead>
            <tbody class="text-wrap">

                @for (otherSubTask of filteredOtherSubTasks; track $index) {
                <tr class="align-middle text-center">

                    @if(!otherSubTask.isEditing){

                    <td>
                        <div class="d-flex gap-1 align-items-center justify-content-center">
                            <button class="custom-btn" (click)="otherSubTask.isEditing = true">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="custom-btn">
                                <!-- (click)="addWorkHrs(otherSubTask)" -->
                                <i class="bi bi-stopwatch"></i>
                            </button>
                        </div>
                    </td>
                    <td>{{ otherSubTask.subTaskSeq }}</td>
                    <td class="display-text-area-data sticky-sub-task-name">{{ otherSubTask.subTaskName }}</td>
                    <td class="display-text-area-data min-width-8 max-width-12">{{ otherSubTask.remark }}</td>
                    <td class="text-nowrap">
                        <span class="badge fs-7"
                            [ngStyle]="{'background-color': colorMap[otherSubTask.status.charAt(0)] || '#4CAF50'}">{{
                            otherSubTask.status }}</span>

                    </td>

                    }
                    @else {

                    <td>
                        <button class="custom-btn"
                            (click)="otherSubTask.isEditing = false; updateOtherSubTask(otherSubTask)">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </td>
                    <td>
                        <input class="custom-input min-max-width-4" type="number" step="1" min="0" inputmode="numeric"
                            [(ngModel)]="otherSubTask.subTaskSeq"
                            (input)="otherSubTask.subTaskSeq = Math.floor(otherSubTask.subTaskSeq || 0)" />
                    </td>
                    <td class="sticky-sub-task-name">
                        <textarea class="custom-input-textarea" [(ngModel)]="otherSubTask.subTaskName"
                            rows="2"></textarea>
                    </td>
                    <td>
                        <textarea class="custom-input-textarea" [(ngModel)]="otherSubTask.remark" rows="2"></textarea>
                    </td>
                    <td>
                        <select class="form-select form-select-sm custom-input-colour w-auto"
                            [(ngModel)]="otherSubTask.status">
                            @for (status of subTaskStatusList; track $index) {
                            <option [ngValue]="status">{{ status }}</option>
                            }
                        </select>
                    </td>

                    }
                    <td>



                        <!-- ================================== -->

                    </td>

                </tr>
                }
            </tbody>
        </table>

    </div>



    <div class="custom-table-footer d-flex justify-content-between align-items-center p-2 rounded-bottom">
        <div>Showing {{ otherSubTasks.length }} Other sub tasks contribution</div>
        <div class="flex-grow-1 d-flex justify-content-center">
            <button class="custom-btn" (click)="addOtherSubTask()">Add Other Contribution Sub Task</button>
        </div>
    </div>
</div>


}

<!-- ================================================================================ -->




@if(isLoading){ <div class="loader-overlay">
    <div class="spinner-border text-primary" role="status"> </div>
</div>}